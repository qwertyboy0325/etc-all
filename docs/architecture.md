# 架構設計

## 系統架構概述

### 整體架構
本系統採用微服務架構，將點雲標注系統分為前端展示層、後端服務層、數據存儲層和消息隊列層。系統設計遵循高可用性、可擴展性和可維護性原則。

### 架構原則
1. **分層架構**：清晰的分層結構，便於維護和擴展
2. **微服務化**：服務間鬆耦合，獨立部署和擴展
3. **API優先**：RESTful API設計，便於整合和測試
4. **容器化**：Docker容器化部署，確保環境一致性
5. **異步處理**：使用消息隊列處理耗時任務
6. **安全第一**：多層安全防護機制

## 系統架構圖

### 高層架構
```
┌─────────────────────────────────────────────────────────────┐
│                        用戶層                                │
├─────────────────────────────────────────────────────────────┤
│  標注員    │  審核員    │  管理員    │  查看者              │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      前端展示層                               │
├─────────────────────────────────────────────────────────────┤
│  React App  │  3D渲染  │  狀態管理  │  權限控制            │
│  (Nginx)    │ (Three.js) │ (Redux)   │ (JWT)               │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      API網關層                               │
├─────────────────────────────────────────────────────────────┤
│  負載均衡  │  API網關  │  認證中心  │  限流控制            │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      後端服務層                               │
├─────────────────────────────────────────────────────────────┤
│ 用戶服務   │ 任務服務   │ 標注服務   │ 審核服務             │
│ (FastAPI)  │ (FastAPI)  │ (FastAPI)  │ (FastAPI)            │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      消息隊列層                               │
├─────────────────────────────────────────────────────────────┤
│  任務隊列   │  消息緩存  │  任務調度  │  結果回調            │
│  (Celery)   │  (Redis)   │  (Beat)    │  (Webhook)           │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      數據存儲層                               │
├─────────────────────────────────────────────────────────────┤
│ 關係型數據庫 │ 緩存數據庫 │ 文件存儲   │ 日誌存儲           │
│ (PostgreSQL) │ (Redis)    │ (MinIO)    │ (ELK)              │
└─────────────────────────────────────────────────────────────┘
```

### 組件架構
```
前端組件架構：
├── src/
│   ├── components/          # 可重用組件
│   │   ├── PointCloudViewer/    # 點雲可視化組件
│   │   ├── AnnotationTools/     # 標注工具組件
│   │   ├── TaskManagement/      # 任務管理組件
│   │   └── UserManagement/      # 用戶管理組件
│   ├── pages/              # 頁面組件
│   ├── services/           # API服務
│   ├── store/              # 狀態管理
│   └── utils/              # 工具函數

後端服務架構：
├── app/
│   ├── api/                # API路由
│   ├── core/               # 核心配置
│   ├── models/             # 數據模型
│   ├── services/           # 業務邏輯
│   ├── utils/              # 工具函數
│   └── workers/            # 背景任務
```

## 核心組件

### 前端架構
- **React Application**：使用React 18作為主框架
- **Three.js渲染引擎**：負責3D點雲渲染
- **狀態管理**：Redux Toolkit管理應用狀態
- **UI組件庫**：Ant Design提供一致的UI體驗
- **路由管理**：React Router處理頁面導航

### 後端架構
- **FastAPI框架**：高性能異步API服務
- **SQLAlchemy ORM**：數據庫操作抽象層
- **Pydantic模型**：數據驗證和序列化
- **Celery任務隊列**：異步任務處理
- **JWT認證**：無狀態身份驗證

### 資料庫架構
- **PostgreSQL**：主數據庫，存儲結構化數據
- **Redis**：緩存和任務隊列
- **MinIO**：對象存儲，處理點雲文件
- **備份策略**：定期備份和災難恢復

### 第三方整合
- **消息隊列**：接收ETC系統傳送的點雲數據
- **訓練Pipeline**：預留API接口供未來整合
- **監控系統**：整合Sentry和Prometheus

## 技術架構

### 技術棧架構
```
展示層：React + Three.js + Ant Design
業務層：FastAPI + SQLAlchemy + Pydantic
數據層：PostgreSQL + Redis + MinIO
消息層：Celery + Redis + RabbitMQ
```

### 部署架構
```
開發環境：Docker Compose
測試環境：Docker Swarm
生產環境：Kubernetes
```

## 設計模式

### 使用的設計模式
1. **MVC模式**：Model-View-Controller分離
2. **Repository模式**：數據訪問層抽象
3. **Factory模式**：服務實例創建
4. **Strategy模式**：不同標注策略
5. **Observer模式**：狀態變化通知

### 架構模式
- **微服務架構**：服務間解耦
- **事件驅動架構**：異步消息處理
- **分層架構**：清晰的職責分離

## 數據流設計

### 數據流圖
```
ETC系統 → 消息隊列 → 任務服務 → 數據庫
    ↓
點雲文件 → 文件存儲 → 前端渲染 → 標注結果
    ↓
標注結果 → 審核服務 → 完成狀態 → 訓練Pipeline
```

### API 設計
- **RESTful API**：標準HTTP方法
- **OpenAPI規範**：自動生成文檔
- **統一響應格式**：一致的錯誤處理
- **版本控制**：API版本管理

## 安全架構

### 安全設計
1. **認證授權**：JWT + RBAC權限控制
2. **數據加密**：HTTPS傳輸加密
3. **輸入驗證**：Pydantic模型驗證
4. **SQL注入防護**：ORM參數化查詢
5. **XSS防護**：前端輸入清理

### 認證授權
- **JWT Token**：無狀態身份認證
- **RBAC**：基於角色的訪問控制
- **權限粒度**：功能級別權限控制

## 性能架構

### 性能設計
1. **數據庫優化**：索引和查詢優化
2. **緩存策略**：Redis多層緩存
3. **CDN加速**：靜態資源分發
4. **壓縮優化**：Gzip壓縮傳輸
5. **分頁查詢**：大數據量分頁處理

### 擴展性設計
- **水平擴展**：負載均衡器
- **垂直擴展**：資源彈性調整
- **微服務架構**：獨立擴展服務
- **數據庫分片**：大數據量處理

## 容災設計

### 高可用性
- **服務冗餘**：多實例部署
- **數據庫主從**：讀寫分離
- **負載均衡**：故障轉移
- **健康檢查**：自動故障檢測

### 災難恢復
- **數據備份**：定期自動備份
- **異地備份**：跨區域部署
- **快速恢復**：RTO < 1小時
- **數據完整性**：RPO < 15分鐘

## 監控與運維

### 監控架構
- **應用監控**：Sentry錯誤追蹤
- **系統監控**：Prometheus + Grafana
- **日誌監控**：ELK Stack
- **業務監控**：自定義儀表板

### 日誌架構
- **結構化日誌**：JSON格式
- **集中收集**：Filebeat + Logstash
- **日誌分析**：Elasticsearch + Kibana
- **日誌保留**：30天滾動保留

## 相關文檔

- [技術棧選擇](tech-stack.md)
- [多專案架構設計](multi-project-architecture.md)
- [後端架構設計](backend/architecture.md)
  - [數據庫設計](backend/database-design.md)
  - [服務層設計](backend/services.md)
  - [API設計](backend/api-design.md)
  - [Clean Architecture設計](backend/clean-architecture.md)
- [前端架構設計](frontend/architecture.md)
- [開發環境配置](development-environment.md)

---
*最後更新：2024年12月19日* 
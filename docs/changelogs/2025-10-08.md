### 開發日誌（2025/10/8）

#### 本次重點
- 上傳系統強化：支援多檔上傳與 ZIP 壓縮包解析，提升大量資料的處理能力。
- 點雲顯示一致性：自動以邊界中心致中，並以 pivot 為樞紐旋轉；NPZ 解析自動修正座標系（Z-up -> Y-up 並水平校正）。
- 權限與指派流程：新增系統管理員的使用者/專案指派；專案管理員可於看板直接指派任務給成員。

#### 變更清單
- 文檔
  - 新增 `docs/api-index.md`（彙整所有 `/api/v1` 端點）。
  - 新增 `docs/open-issues/architecture-vs-implementation.md` 與索引 `docs/open-issues/README.md`。
  - 更新 `docs/README.md` 加上「Open Issues」與「API 索引」；本次新增「開發日誌」索引。

- 後端（FastAPI）
  - 檔案上傳：
    - 新增 `POST /api/v1/projects/{project_id}/files/upload-multi`（多檔上傳）。
    - 新增 `POST /api/v1/projects/{project_id}/files/upload-archive`（ZIP 檔上傳，擷取 .npy/.npz 並逐一入庫）。
  - 專案管理：
    - 新增 `GET /api/v1/projects/admin/all`（系統/全域管理員列出所有專案）。
    - 新增 `POST /api/v1/projects/{project_id}/members/assign-admin?user_id=...`（指派使用者為 `project_admin`）。
    - 修正 `projects.py` 缺少 except 導致語法錯誤的問題，補上 `except` 並整理 imports。
  - 使用者管理：
    - 新增 `/api/v1/users`：
      - `GET /api/v1/users`（admin）列出使用者，支援 `q`、`role`。
      - `PUT /api/v1/users/{user_id}/role?new_role=...`（system_admin）調整全域角色。
      - `DELETE /api/v1/users/{user_id}`（admin）停用使用者。
    - 將 `users` 路由掛載到主路由（`api_router`）。

- 前端（React + Ant Design + Three.js）
  - 認證修正：
    - `AuthContext.checkAuth` 啟動時驗證 `verify-token`，無效即清除，避免未登入時 UI 誤顯示登入。
  - 導覽列：
    - 新增「使用者管理」按鈕（僅 admin/system_admin 顯示），導向 `/admin/users`。
  - 點雲渲染：
    - `PointCloudRenderer` 改為載入時「固定致中」：以邊界中心平移至原點；新增 `pivot` 群組，所有旋轉（自動/手動）繞 pivot。
    - 移除 UI 致中選項。
    - `npzParser` 在解析時固定做座標系轉換（X 保持、Y=-Z、Z=Y），並水平校正（繞 Z 軸 -90°）。
  - 批量上傳 UI：
    - `ProjectManagement` 在專案表格操作列新增「上傳」「上傳ZIP」按鈕；串接多檔/ZIP 端點。
    - 修正 `Upload is not defined`（補上 `import { Upload } from 'antd'`）。
  - 使用者管理 UI：
    - 新增 `/admin/users`（`UserManagement.tsx`）：搜尋/篩選，system_admin 可改全域角色，admin 可停用。
    - system_admin 可在此指派使用者為某專案的 `project_admin`（彈框選專案）。
  - 任務指派 UI：
    - `TaskBoard` 在任務卡加入「指派」按鈕，開啟對話框載入專案成員並送出；`TaskManagement` 看板模式透過 `onAssign` 串接後端 `POST /projects/{project_id}/tasks/{task_id}/assign`。
  - 任務建立與檔案預覽修正：
    - `TaskCreateModal`：修正預覽時 `filename` 可能為 `undefined` 造成 `endsWith` 例外，統一以 `original_filename || filename` 判斷副檔名並加上空值防護；下載改用 `API_BASE_URL` + 認證標頭。
    - `TaskManagement`：建立任務前優先載入 `GET /projects/{project_id}/files?page=1&size=100`，確保 `pointcloud_file_id` 為有效 UUID；移除回退全域 `/files`，避免混用本地開發檔案ID。
  - 專案管理：
    - `ProjectManagement`：新增「指派管理員」操作（System Admin 可見），透過 `POST /projects/{project_id}/members/assign-admin?user_id=...` 指派使用者為該專案 `project_admin`。

#### 待辦 / 後續
- 後端：將上傳與分析背景化（Celery + Redis），避免大檔阻塞同步請求。
- 前端：批量上傳成功後的一鍵「為成功檔案建立任務」。
- 監控：加入 Prometheus/Sentry 與結構化日誌。


